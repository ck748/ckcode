# ğŸ‰ åŒºå—é“¾éƒ¨ç½²å®Œæˆ - ä½¿ç”¨æŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. è¯ä¹¦å’Œé…ç½®è¿ç§»
- âœ… ä»Demo01å¤åˆ¶äº†åŒºå—é“¾è¯ä¹¦æ–‡ä»¶åˆ° `defectDetection/src/main/resources/blockchain/conf/`
  - ca.crt
  - sdk.crt
  - sdk.key

### 2. æ™ºèƒ½åˆçº¦è¿ç§»
- âœ… å¤åˆ¶äº†æ‰€æœ‰æ™ºèƒ½åˆçº¦æ–‡ä»¶åˆ° `defectDetection/src/main/resources/contracts/`
  - RawMaterial.sol - åŸææ–™åˆçº¦
  - DataCenter.sol - æ•°æ®ä¸­å¿ƒåˆçº¦
  - Workshop1-5.sol - è½¦é—´åˆçº¦

### 3. ABIæ–‡ä»¶è¿ç§»
- âœ… å¤åˆ¶äº†åˆçº¦ABIæ–‡ä»¶åˆ° `defectDetection/src/main/resources/blockchain/abi/`

### 4. é…ç½®æ–‡ä»¶æ›´æ–°
- âœ… æ›´æ–°äº† `application.yaml`:
  - å¯ç”¨åŒºå—é“¾åŠŸèƒ½ (`enabled: true`)
  - é…ç½®èŠ‚ç‚¹åœ°å€ (`127.0.0.1:5002`)
  - é…ç½®ç§é’¥
  - å¡«å†™æ‰€æœ‰åˆçº¦åœ°å€

### 5. æœåŠ¡ç±»åˆ›å»º
- âœ… åˆ›å»ºäº† `RawMaterialService` - åŸææ–™åˆçº¦æœåŠ¡
- âœ… åˆ›å»ºäº† `RawMaterialController` - åŸææ–™æ¥å£æ§åˆ¶å™¨

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: ç¡®ä¿FISCO BCOSèŠ‚ç‚¹è¿è¡Œ

ä½ çš„Demo01é…ç½®æ˜¾ç¤ºèŠ‚ç‚¹åœ°å€æ˜¯ `127.0.0.1:5002`,è¯·ç¡®ä¿èŠ‚ç‚¹æ­£åœ¨è¿è¡Œ:

```powershell
# æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦è¿è¡Œ
netstat -an | findstr 5002

# å¦‚æœçœ‹åˆ°ç±»ä¼¼è¾“å‡ºè¯´æ˜èŠ‚ç‚¹åœ¨è¿è¡Œ:
# TCP    127.0.0.1:5002    0.0.0.0:0    LISTENING
```

**å¦‚æœèŠ‚ç‚¹æ²¡æœ‰è¿è¡Œ,è¯·å¯åŠ¨FISCO BCOSèŠ‚ç‚¹ã€‚**

### æ­¥éª¤2: å¯åŠ¨é¡¹ç›®

```powershell
cd c:\Users\LENOVO\Desktop\v3q\DefectDetection\defectDetection

# æ¸…ç†å¹¶ç¼–è¯‘
mvn clean install -DskipTests

# å¯åŠ¨é¡¹ç›®
mvn spring-boot:run
```

### æ­¥éª¤3: æŸ¥çœ‹å¯åŠ¨æ—¥å¿—

å¯åŠ¨æˆåŠŸå,ä½ åº”è¯¥çœ‹åˆ°:

```
âœ… åŒºå—é“¾è¿æ¥æˆåŠŸ! å½“å‰åŒºå—é«˜åº¦: XXX
ğŸ” åŠ å¯†å¥—ä»¶å·²é…ç½®, åœ°å€: 0x...
âœ… RawMaterialæœåŠ¡åˆå§‹åŒ–æˆåŠŸ, åˆçº¦åœ°å€: 0x2f7815612e2a0bc6f5ee01a48ab7844e3b80d6a4
```

### æ­¥éª¤4: è®¿é—®Swaggeræµ‹è¯•æ¥å£

æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:8081/swagger-ui/index.html

ä½ ä¼šçœ‹åˆ°æ–°å¢çš„æ¥å£:

#### ğŸ“¦ blockchain-controller (åŒºå—é“¾åŸºç¡€æ¥å£)
- `GET /blockchain/status` - æŸ¥çœ‹åŒºå—é“¾çŠ¶æ€
- `GET /blockchain/blockNumber` - æŸ¥çœ‹åŒºå—é«˜åº¦

#### ğŸ­ raw-material-controller (åŸææ–™åŒºå—é“¾æ¥å£)
- `POST /blockchain/rawMaterial/set` - è®¾ç½®åŸææ–™ä¿¡æ¯
- `GET /blockchain/rawMaterial/get` - è·å–åŸææ–™ä¿¡æ¯
- `GET /blockchain/rawMaterial/batchId` - è·å–æ‰¹æ¬¡ID
- `POST /blockchain/rawMaterial/test` - ä¸€é”®æµ‹è¯•
- `GET /blockchain/rawMaterial/status` - æ£€æŸ¥æœåŠ¡çŠ¶æ€

---

## ğŸ§ª æµ‹è¯•æ¥å£

### æµ‹è¯•1: æ£€æŸ¥åŒºå—é“¾è¿æ¥

```bash
curl http://localhost:8081/blockchain/status
```

**é¢„æœŸå“åº”:**
```json
{
  "code": 200,
  "message": "è·å–åŒºå—é“¾çŠ¶æ€æˆåŠŸ",
  "data": {
    "available": true,
    "blockNumber": 123,
    "message": "åŒºå—é“¾æœåŠ¡è¿è¡Œæ­£å¸¸"
  }
}
```

### æµ‹è¯•2: æ£€æŸ¥åŸææ–™æœåŠ¡çŠ¶æ€

```bash
curl http://localhost:8081/blockchain/rawMaterial/status
```

**é¢„æœŸå“åº”:**
```json
{
  "code": 200,
  "message": "æœåŠ¡å¯ç”¨",
  "data": {
    "available": true,
    "service": "RawMaterial",
    "message": "æœåŠ¡æ­£å¸¸"
  }
}
```

### æµ‹è¯•3: ä¸€é”®æµ‹è¯•åŸææ–™åˆçº¦

åœ¨Swaggerä¸­ç‚¹å‡» `POST /blockchain/rawMaterial/test` çš„ "Try it out" æŒ‰é’®,ç„¶åç‚¹å‡» "Execute"

æˆ–ä½¿ç”¨curl:
```bash
curl -X POST http://localhost:8081/blockchain/rawMaterial/test
```

**é¢„æœŸå“åº”:**
```json
{
  "code": 200,
  "message": "æµ‹è¯•å®Œæˆ",
  "data": {
    "è®¾ç½®ç»“æœ": {
      "success": true,
      "transactionHash": "0x...",
      "blockNumber": "124",
      "message": "åŸææ–™ä¿¡æ¯è®¾ç½®æˆåŠŸ"
    },
    "æŸ¥è¯¢ç»“æœ": {
      "success": true,
      "rawProducerAddr": "åŒ—äº¬åŸææ–™ç”Ÿäº§å•†A",
      "axleProducerAddr": "ä¸Šæµ·è½´æ‰¿åˆ¶é€ å•†B",
      "totalRawWeight": 1000,
      "batchId": "BATCH-2024-12-04-001"
    }
  }
}
```

### æµ‹è¯•4: æ‰‹åŠ¨è®¾ç½®åŸææ–™ä¿¡æ¯

```bash
curl -X POST "http://localhost:8081/blockchain/rawMaterial/set" \
  -d "rawProducerAddr=å¹¿å·åŸææ–™ä¾›åº”å•†" \
  -d "axleProducerAddr=æ·±åœ³è½´æ‰¿å‚" \
  -d "totalRawWeight=2000" \
  -d "batchId=BATCH-2024-12-04-002"
```

### æµ‹è¯•5: æŸ¥è¯¢åŸææ–™ä¿¡æ¯

```bash
curl http://localhost:8081/blockchain/rawMaterial/get
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ä½ çš„ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨

#### ç¤ºä¾‹1: è®°å½•ç¼ºé™·æ£€æµ‹ç›¸å…³çš„åŸææ–™ä¿¡æ¯

```java
@Service
public class YourBusinessService {
    
    @Autowired(required = false)
    private RawMaterialService rawMaterialService;
    
    public void recordDefectWithMaterial(Defection defection, String batchId) {
        // 1. ä¿å­˜ç¼ºé™·åˆ°æ•°æ®åº“
        defectionService.save(defection);
        
        // 2. å¦‚æœåŒºå—é“¾å¯ç”¨,è®°å½•åŸææ–™ä¿¡æ¯
        if (rawMaterialService != null && rawMaterialService.isAvailable()) {
            Map<String, Object> result = rawMaterialService.setRawMaterial(
                "åŸææ–™ç”Ÿäº§å•†åç§°",
                "è½´æ‰¿åˆ¶é€ å•†åç§°",
                1000L,
                batchId
            );
            
            if ((Boolean) result.get("success")) {
                log.info("åŸææ–™ä¿¡æ¯å·²ä¸Šé“¾,äº¤æ˜“å“ˆå¸Œ: {}", 
                    result.get("transactionHash"));
            }
        }
    }
}
```

#### ç¤ºä¾‹2: æŸ¥è¯¢å¹¶éªŒè¯åŸææ–™ä¿¡æ¯

```java
public void verifyMaterialInfo(String expectedBatchId) {
    if (rawMaterialService != null && rawMaterialService.isAvailable()) {
        Map<String, Object> result = rawMaterialService.getRawMaterial();
        
        if ((Boolean) result.get("success")) {
            String batchId = (String) result.get("batchId");
            
            if (expectedBatchId.equals(batchId)) {
                log.info("æ‰¹æ¬¡IDéªŒè¯é€šè¿‡: {}", batchId);
            } else {
                log.warn("æ‰¹æ¬¡IDä¸åŒ¹é…! æœŸæœ›: {}, å®é™…: {}", 
                    expectedBatchId, batchId);
            }
        }
    }
}
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
defectDetection/
â”œâ”€â”€ src/main/
â”‚   â”œâ”€â”€ java/com/ggbond/defectdetection/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ BlockchainConfig.java           # åŒºå—é“¾é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ FiscoBcosSdkConfig.java         # SDKé…ç½®
â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â”œâ”€â”€ BlockchainController.java       # åŒºå—é“¾åŸºç¡€æ¥å£
â”‚   â”‚   â”‚   â””â”€â”€ RawMaterialController.java      # åŸææ–™æ¥å£ âœ¨NEW
â”‚   â”‚   â””â”€â”€ service/blockchain/
â”‚   â”‚       â”œâ”€â”€ BlockchainService.java          # åŒºå—é“¾åŸºç¡€æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ DefectTraceService.java         # ç¼ºé™·æº¯æºæœåŠ¡
â”‚   â”‚       â””â”€â”€ RawMaterialService.java         # åŸææ–™æœåŠ¡ âœ¨NEW
â”‚   â””â”€â”€ resources/
â”‚       â”œâ”€â”€ blockchain/
â”‚       â”‚   â”œâ”€â”€ conf/                            # è¯ä¹¦æ–‡ä»¶ âœ¨COPIED
â”‚       â”‚   â”‚   â”œâ”€â”€ ca.crt
â”‚       â”‚   â”‚   â”œâ”€â”€ sdk.crt
â”‚       â”‚   â”‚   â””â”€â”€ sdk.key
â”‚       â”‚   â””â”€â”€ abi/                             # ABIæ–‡ä»¶ âœ¨COPIED
â”‚       â”‚       â”œâ”€â”€ RawMaterial.abi
â”‚       â”‚       â”œâ”€â”€ Workshop4.abi
â”‚       â”‚       â””â”€â”€ Workshop5.abi
â”‚       â”œâ”€â”€ contracts/                           # æ™ºèƒ½åˆçº¦ âœ¨COPIED
â”‚       â”‚   â”œâ”€â”€ RawMaterial.sol
â”‚       â”‚   â”œâ”€â”€ DataCenter.sol
â”‚       â”‚   â”œâ”€â”€ Workshop1.sol
â”‚       â”‚   â”œâ”€â”€ Workshop2.sol
â”‚       â”‚   â”œâ”€â”€ Workshop3.sol
â”‚       â”‚   â”œâ”€â”€ Workshop4.sol
â”‚       â”‚   â”œâ”€â”€ Workshop5.sol
â”‚       â”‚   â””â”€â”€ DefectTrace.sol
â”‚       â””â”€â”€ application.yaml                     # é…ç½®æ–‡ä»¶ âœ¨UPDATED
â””â”€â”€ pom.xml                                      # Mavenä¾èµ– âœ¨UPDATED
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### application.yaml é…ç½®è¯¦è§£

```yaml
blockchain:
  enabled: true                                   # âœ… å·²å¯ç”¨
  peers: 127.0.0.1:5002                          # âœ… ä½¿ç”¨Demo01çš„èŠ‚ç‚¹
  group-id: 1                                     # âœ… ç¾¤ç»„ID
  cert-path: blockchain/conf                      # âœ… è¯ä¹¦è·¯å¾„å·²æ›´æ–°
  hex-private-key: 133c66ebc...                  # âœ… ä½¿ç”¨Demo01çš„ç§é’¥
  contracts:
    raw-material: "0x2f7815612e2a..."           # âœ… åŸææ–™åˆçº¦åœ°å€
    data-center: "0xe4f16e2196c8..."            # âœ… æ•°æ®ä¸­å¿ƒåˆçº¦åœ°å€
    workshop1: "0x25437f96c27c..."              # âœ… è½¦é—´1åˆçº¦åœ°å€
    workshop2: "0x04d5f985d011..."              # âœ… è½¦é—´2åˆçº¦åœ°å€
    workshop3: "0x46db562c915a..."              # âœ… è½¦é—´3åˆçº¦åœ°å€
    workshop4: "0x195e8fd784d0..."              # âœ… è½¦é—´4åˆçº¦åœ°å€
    workshop5: "0x2017c5fea8af..."              # âœ… è½¦é—´5åˆçº¦åœ°å€
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¯åŠ¨æ—¶æŠ¥é”™ "æ— æ³•è¿æ¥åˆ°FISCO BCOSèŠ‚ç‚¹"

**è§£å†³æ–¹æ¡ˆ:**
1. æ£€æŸ¥FISCO BCOSèŠ‚ç‚¹æ˜¯å¦è¿è¡Œ:
   ```powershell
   netstat -an | findstr 5002
   ```

2. å¦‚æœæ²¡æœ‰è¿è¡Œ,å¯åŠ¨Demo01é¡¹ç›®æˆ–å•ç‹¬å¯åŠ¨èŠ‚ç‚¹

3. ç¡®è®¤èŠ‚ç‚¹åœ°å€å’Œç«¯å£æ­£ç¡®

### Q2: å¯åŠ¨æ­£å¸¸ä½†æ¥å£è°ƒç”¨å¤±è´¥

**æ£€æŸ¥é¡¹:**
1. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰ "âœ… RawMaterialæœåŠ¡åˆå§‹åŒ–æˆåŠŸ"
2. è®¿é—® `/blockchain/rawMaterial/status` æ£€æŸ¥æœåŠ¡çŠ¶æ€
3. ç¡®è®¤åˆçº¦åœ°å€é…ç½®æ­£ç¡®

### Q3: æƒ³ä¸´æ—¶ç¦ç”¨åŒºå—é“¾åŠŸèƒ½

ä¿®æ”¹ `application.yaml`:
```yaml
blockchain:
  enabled: false  # æ”¹ä¸ºfalseå³å¯
```

### Q4: å¦‚ä½•æ·»åŠ å…¶ä»–åˆçº¦æœåŠ¡?

å‚è€ƒ `RawMaterialService.java`,æŒ‰ç›¸åŒæ¨¡å¼åˆ›å»º:
1. åˆ›å»ºæœåŠ¡ç±»ç»§æ‰¿ç›¸åŒç»“æ„
2. åŠ è½½å¯¹åº”çš„ABIæ–‡ä»¶
3. å®ç°åˆçº¦æ–¹æ³•è°ƒç”¨
4. åˆ›å»ºå¯¹åº”çš„Controller

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… **æµ‹è¯•æ¥å£** - ä½¿ç”¨Swaggeræµ‹è¯•æ‰€æœ‰æ¥å£
2. âœ… **éªŒè¯åŠŸèƒ½** - æ‰§è¡Œä¸€é”®æµ‹è¯•ç¡®è®¤åŠŸèƒ½æ­£å¸¸
3. ğŸ”„ **æ‰©å±•æœåŠ¡** - æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–åˆçº¦æœåŠ¡(DataCenter, Workshopç­‰)
4. ğŸ”„ **é›†æˆä¸šåŠ¡** - åœ¨ç¼ºé™·æ£€æµ‹æµç¨‹ä¸­è°ƒç”¨åŒºå—é“¾æœåŠ¡

---

## ğŸ“ éœ€è¦å¸®åŠ©?

å¦‚æœé‡åˆ°é—®é¢˜:
1. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
2. è®¿é—® `/blockchain/status` æ£€æŸ¥è¿æ¥
3. è®¿é—® `/blockchain/rawMaterial/status` æ£€æŸ¥æœåŠ¡
4. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†

---

**éƒ¨ç½²å®Œæˆæ—¶é—´:** 2024å¹´12æœˆ4æ—¥  
**çŠ¶æ€:** âœ… å¯ä»¥ç«‹å³ä½¿ç”¨  
**è¯´æ˜:** åŒºå—é“¾åŠŸèƒ½å·²å®Œå…¨é›†æˆå¹¶å¯ç”¨!
