# åŒºå—é“¾éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å‰ç½®å‡†å¤‡](#å‰ç½®å‡†å¤‡)
3. [FISCO BCOSèŠ‚ç‚¹éƒ¨ç½²](#fisco-bcosèŠ‚ç‚¹éƒ¨ç½²)
4. [æ™ºèƒ½åˆçº¦éƒ¨ç½²](#æ™ºèƒ½åˆçº¦éƒ¨ç½²)
5. [é¡¹ç›®é…ç½®](#é¡¹ç›®é…ç½®)
6. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆFISCO BCOSåŒºå—é“¾,ç”¨äºå®ç°ç¼ºé™·æ£€æµ‹æ•°æ®çš„ä¸å¯ç¯¡æ”¹æº¯æºã€‚

### é›†æˆå†…å®¹
- âœ… FISCO BCOS Java SDK 3.6.0
- âœ… åŒºå—é“¾é…ç½®ç±» (`BlockchainConfig`)
- âœ… SDKé…ç½®ç±» (`FiscoBcosSdkConfig`)
- âœ… åŒºå—é“¾æœåŠ¡ (`BlockchainService`)
- âœ… ç¼ºé™·æº¯æºæœåŠ¡ (`DefectTraceService`)
- âœ… åŒºå—é“¾æ§åˆ¶å™¨ (`BlockchainController`)
- âœ… ç¼ºé™·æº¯æºæ™ºèƒ½åˆçº¦ (`DefectTrace.sol`)

### ç›®å½•ç»“æ„
```
defectDetection/
â”œâ”€â”€ src/main/
â”‚   â”œâ”€â”€ java/com/ggbond/defectdetection/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ BlockchainConfig.java           # åŒºå—é“¾é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ FiscoBcosSdkConfig.java         # FISCO SDKé…ç½®
â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â””â”€â”€ BlockchainController.java       # åŒºå—é“¾æ¥å£
â”‚   â”‚   â””â”€â”€ service/blockchain/
â”‚   â”‚       â”œâ”€â”€ BlockchainService.java          # åŒºå—é“¾åŸºç¡€æœåŠ¡
â”‚   â”‚       â””â”€â”€ DefectTraceService.java         # ç¼ºé™·æº¯æºæœåŠ¡
â”‚   â””â”€â”€ resources/
â”‚       â”œâ”€â”€ application.yaml                     # åº”ç”¨é…ç½®
â”‚       â”œâ”€â”€ contracts/
â”‚       â”‚   â””â”€â”€ DefectTrace.sol                 # æ™ºèƒ½åˆçº¦
â”‚       â””â”€â”€ blockchain/conf/                     # åŒºå—é“¾è¯ä¹¦(éœ€éƒ¨ç½²åå¤åˆ¶)
â””â”€â”€ pom.xml                                      # Mavenä¾èµ–é…ç½®
```

---

## å‰ç½®å‡†å¤‡

### 1. ç¯å¢ƒè¦æ±‚
- **Java**: JDK 17+
- **æ“ä½œç³»ç»Ÿ**: Windows/Linux/MacOS
- **ç½‘ç»œ**: ç¡®ä¿é˜²ç«å¢™å…è®¸åŒºå—é“¾èŠ‚ç‚¹é€šä¿¡

### 2. ä¸‹è½½FISCO BCOSæ§åˆ¶å°
```bash
cd ~/fisco
curl -#LO https://github.com/FISCO-BCOS/console/releases/download/v3.6.0/download_console.sh

# æ‰§è¡Œè„šæœ¬,ä¸‹è½½æ§åˆ¶å°
bash download_console.sh
```

---

## FISCO BCOSèŠ‚ç‚¹éƒ¨ç½²

### æ–¹æ¡ˆä¸€: ä½¿ç”¨å»ºé“¾è„šæœ¬(æ¨è-å¿«é€Ÿéƒ¨ç½²)

```bash
# 1. åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p ~/fisco
cd ~/fisco

# 2. ä¸‹è½½å»ºé“¾è„šæœ¬
curl -#LO https://github.com/FISCO-BCOS/FISCO-BCOS/releases/download/v3.6.0/build_chain.sh
chmod +x build_chain.sh

# 3. æ„å»ºå•æœº4èŠ‚ç‚¹è”ç›Ÿé“¾
bash build_chain.sh -l 127.0.0.1:4 -p 30300,20200 -e ~/fisco/fisco-bcos

# å‚æ•°è¯´æ˜:
# -l 127.0.0.1:4  è¡¨ç¤ºåœ¨æœ¬åœ°ç”Ÿæˆ4ä¸ªèŠ‚ç‚¹
# -p 30300,20200  P2Pç«¯å£å’ŒRPCç«¯å£èµ·å§‹å€¼
# -e              æŒ‡å®šfisco-bcosäºŒè¿›åˆ¶è·¯å¾„

# 4. å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹
bash nodes/127.0.0.1/start_all.sh

# 5. æ£€æŸ¥èŠ‚ç‚¹è¿›ç¨‹
ps aux | grep fisco-bcos
```

### æ–¹æ¡ˆäºŒ: ä½¿ç”¨Docker(æ¨è-å¼€å‘æµ‹è¯•)

```bash
# æ‹‰å–FISCO BCOSé•œåƒ
docker pull fiscoorg/fiscobcos:v3.6.0

# è¿è¡ŒèŠ‚ç‚¹å®¹å™¨
docker run -d \
  --name fisco-node \
  -p 30300:30300 \
  -p 20200:20200 \
  fiscoorg/fiscobcos:v3.6.0
```

### éªŒè¯èŠ‚ç‚¹è¿è¡Œ

```bash
# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
tail -f nodes/127.0.0.1/node0/log/log* | grep "Report"

# æ­£å¸¸è¾“å‡ºç¤ºä¾‹:
# info|2024-12-03 10:00:00.123|[CONSENSUS][PBFT]|Report|blockNumber=1,view=0
```

---

## æ™ºèƒ½åˆçº¦éƒ¨ç½²

### 1. å®‰è£…Solidityç¼–è¯‘å™¨

```bash
# ä½¿ç”¨npmå®‰è£…solcjs
npm install -g solc

# éªŒè¯å®‰è£…
solcjs --version
```

### 2. ç¼–è¯‘æ™ºèƒ½åˆçº¦

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/DefectDetection/defectDetection

# ç¼–è¯‘åˆçº¦
solcjs --bin --abi --include-path src/main/resources/contracts/ \
  --base-path . src/main/resources/contracts/DefectTrace.sol \
  -o src/main/resources/contracts/build/

# ä¼šç”Ÿæˆ:
# - DefectTrace.bin (å­—èŠ‚ç )
# - DefectTrace.abi (æ¥å£å®šä¹‰)
```

### 3. ä½¿ç”¨æ§åˆ¶å°éƒ¨ç½²åˆçº¦

```bash
# å¯åŠ¨FISCO BCOSæ§åˆ¶å°
cd ~/fisco/console
bash start.sh

# åœ¨æ§åˆ¶å°ä¸­éƒ¨ç½²åˆçº¦
[group0]: deploy DefectTrace

# è®°å½•è¾“å‡ºçš„åˆçº¦åœ°å€,ä¾‹å¦‚:
# contract address: 0x1234567890abcdef1234567890abcdef12345678
```

### 4. å¤åˆ¶è¯ä¹¦åˆ°é¡¹ç›®

```bash
# å°†èŠ‚ç‚¹è¯ä¹¦å¤åˆ¶åˆ°é¡¹ç›®
mkdir -p ~/DefectDetection/defectDetection/src/main/resources/blockchain/conf

cp ~/fisco/nodes/127.0.0.1/sdk/* \
   ~/DefectDetection/defectDetection/src/main/resources/blockchain/conf/

# åº”è¯¥åŒ…å«:
# - ca.crt
# - sdk.crt  
# - sdk.key
```

---

## é¡¹ç›®é…ç½®

### 1. ä¿®æ”¹ application.yaml

ç¼–è¾‘ `defectDetection/src/main/resources/application.yaml`:

```yaml
# åŒºå—é“¾é…ç½®
blockchain:
  # å¯ç”¨åŒºå—é“¾åŠŸèƒ½
  enabled: true
  
  # FISCO BCOSèŠ‚ç‚¹é…ç½®(æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹)
  peers: 127.0.0.1:20200
  
  # ç¾¤ç»„ID
  group-id: group0
  
  # è¯ä¹¦è·¯å¾„
  cert-path: blockchain/conf
  
  # ç§é’¥(å¯é€‰,ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ)
  hex-private-key: ""
  
  # æ™ºèƒ½åˆçº¦åœ°å€(å¡«å†™éƒ¨ç½²åçš„åœ°å€)
  contracts:
    defect-trace: "0x1234567890abcdef1234567890abcdef12345678"  # æ›¿æ¢ä¸ºå®é™…åœ°å€
    raw-material: ""
    data-center: ""
```

### 2. Mavenä¾èµ–åˆ·æ–°

```bash
# åˆ·æ–°Mavenä¾èµ–
cd ~/DefectDetection/defectDetection
mvn clean install -DskipTests
```

---

## æµ‹è¯•éªŒè¯

### 1. å¯åŠ¨é¡¹ç›®

```bash
# å¯åŠ¨Spring Bootåº”ç”¨
mvn spring-boot:run

# æˆ–ä½¿ç”¨IDEå¯åŠ¨ DefectDetectionApplication
```

### 2. æ£€æŸ¥åŒºå—é“¾è¿æ¥

æŸ¥çœ‹å¯åŠ¨æ—¥å¿—,åº”è¯¥çœ‹åˆ°:

```
âœ… åŒºå—é“¾è¿æ¥æˆåŠŸ! å½“å‰åŒºå—é«˜åº¦: 1
ğŸ” åŠ å¯†å¥—ä»¶å·²é…ç½®, åœ°å€: 0xabcdef...
```

### 3. æµ‹è¯•APIæ¥å£

#### è·å–åŒºå—é“¾çŠ¶æ€
```bash
curl http://localhost:8081/blockchain/status
```

**é¢„æœŸå“åº”:**
```json
{
  "code": 200,
  "message": "è·å–åŒºå—é“¾çŠ¶æ€æˆåŠŸ",
  "data": {
    "available": true,
    "blockNumber": 1,
    "message": "åŒºå—é“¾æœåŠ¡è¿è¡Œæ­£å¸¸"
  }
}
```

#### è·å–åŒºå—é«˜åº¦
```bash
curl http://localhost:8081/blockchain/blockNumber
```

### 4. Swaggeræµ‹è¯•

è®¿é—® Swagger UI: http://localhost:8081/swagger-ui/index.html

æ‰¾åˆ° `blockchain-controller`,æµ‹è¯•ä»¥ä¸‹æ¥å£:
- `GET /blockchain/status` - è·å–åŒºå—é“¾çŠ¶æ€
- `GET /blockchain/blockNumber` - è·å–åŒºå—é«˜åº¦

---

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨ä»£ç ä¸­ä½¿ç”¨åŒºå—é“¾æœåŠ¡

```java
@Service
public class YourService {
    
    @Autowired(required = false)
    private DefectTraceService defectTraceService;
    
    public void saveDefect(Defection defection) {
        // ä¿å­˜åˆ°æ•°æ®åº“
        defectionMapper.insert(defection);
        
        // åŒæ—¶ä¸Šé“¾
        if (defectTraceService != null) {
            String txHash = defectTraceService.saveDefectToChain(defection);
            log.info("ç¼ºé™·ä¿¡æ¯å·²ä¸Šé“¾,äº¤æ˜“å“ˆå¸Œ: {}", txHash);
        }
    }
}
```

---

## å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘é”™è¯¯ - æ‰¾ä¸åˆ°FISCO SDKç±»

**è§£å†³æ–¹æ¡ˆ:**
```bash
# åˆ·æ–°Mavenä¾èµ–
mvn clean install -DskipTests

# æˆ–åœ¨IDEä¸­: Maven -> Reload Project
```

### Q2: è¿æ¥åŒºå—é“¾å¤±è´¥

**æ£€æŸ¥é¡¹:**
1. FISCO BCOSèŠ‚ç‚¹æ˜¯å¦è¿è¡Œ
   ```bash
   ps aux | grep fisco-bcos
   ```

2. ç«¯å£æ˜¯å¦æ­£ç¡®
   ```bash
   netstat -an | grep 20200
   ```

3. è¯ä¹¦è·¯å¾„æ˜¯å¦æ­£ç¡®
   ```bash
   ls -la src/main/resources/blockchain/conf/
   ```

### Q3: åŒºå—é“¾åŠŸèƒ½æš‚æ—¶ä¸ç”¨,å¦‚ä½•ç¦ç”¨?

ä¿®æ”¹ `application.yaml`:
```yaml
blockchain:
  enabled: false  # è®¾ç½®ä¸ºfalseå³å¯
```

### Q4: å¦‚ä½•æŸ¥çœ‹åŒºå—é“¾äº¤æ˜“è®°å½•?

ä½¿ç”¨FISCO BCOSæ§åˆ¶å°:
```bash
cd ~/fisco/console
bash start.sh

# æŸ¥çœ‹äº¤æ˜“
[group0]: getTransactionByHash 0xäº¤æ˜“å“ˆå¸Œ

# æŸ¥çœ‹åŒºå—
[group0]: getBlockByNumber 1
```

---

## è¿›é˜¶é…ç½®

### å¤šèŠ‚ç‚¹éƒ¨ç½²

ä¿®æ”¹ `application.yaml`:
```yaml
blockchain:
  peers: 127.0.0.1:20200,127.0.0.1:20201,127.0.0.1:20202
```

### ä½¿ç”¨å›½å¯†ç®—æ³•

1. å»ºé“¾æ—¶æŒ‡å®šå›½å¯†:
```bash
bash build_chain.sh -l 127.0.0.1:4 -g
```

2. é¡¹ç›®æ— éœ€ä¿®æ”¹,SDKä¼šè‡ªåŠ¨é€‚é…

---

## ä¸‹ä¸€æ­¥

1. âœ… **å®ŒæˆèŠ‚ç‚¹éƒ¨ç½²** - æŒ‰ç…§æœ¬æŒ‡å—éƒ¨ç½²FISCO BCOSèŠ‚ç‚¹
2. âœ… **éƒ¨ç½²æ™ºèƒ½åˆçº¦** - ç¼–è¯‘å¹¶éƒ¨ç½²DefectTraceåˆçº¦
3. âœ… **é…ç½®é¡¹ç›®** - ä¿®æ”¹application.yamlå¡«å…¥åˆçº¦åœ°å€
4. âœ… **æµ‹è¯•æ¥å£** - ä½¿ç”¨Swaggeræˆ–curlæµ‹è¯•åŒºå—é“¾æ¥å£
5. ğŸš€ **é›†æˆä¸šåŠ¡** - åœ¨ç¼ºé™·æ£€æµ‹æµç¨‹ä¸­è°ƒç”¨åŒºå—é“¾æœåŠ¡

---

## å‚è€ƒæ–‡æ¡£

- [FISCO BCOSå®˜æ–¹æ–‡æ¡£](https://fisco-bcos-doc.readthedocs.io/)
- [Java SDKæ–‡æ¡£](https://fisco-bcos-doc.readthedocs.io/zh_CN/latest/docs/sdk/java_sdk/index.html)
- [æ™ºèƒ½åˆçº¦å¼€å‘](https://fisco-bcos-doc.readthedocs.io/zh_CN/latest/docs/tutorial/index.html)

---

**åˆ›å»ºæ—¶é—´:** 2024å¹´12æœˆ3æ—¥  
**ç‰ˆæœ¬:** 1.0.0
