# ğŸ”— åŒºå—é“¾é›†æˆ - å¿«é€Ÿå…¥é—¨

## âœ… å·²å®Œæˆçš„é›†æˆå·¥ä½œ

æ­å–œ!åŒºå—é“¾åŠŸèƒ½å·²ç»æˆåŠŸé›†æˆåˆ°é¡¹ç›®ä¸­,ä»¥ä¸‹æ˜¯å·²å®Œæˆçš„å·¥ä½œ:

### ğŸ“¦ 1. ä¾èµ–é…ç½®
- âœ… æ·»åŠ  FISCO BCOS Java SDK 3.6.0 åˆ° `pom.xml`
- âœ… é…ç½®æ’é™¤å†²çªçš„ä¾èµ–

### âš™ï¸ 2. é…ç½®æ–‡ä»¶
- âœ… åœ¨ `application.yaml` ä¸­æ·»åŠ åŒºå—é“¾é…ç½®
- âœ… é»˜è®¤çŠ¶æ€: **ç¦ç”¨** (`enabled: false`)
- âœ… å¯é€šè¿‡é…ç½®å¼€å…³è½»æ¾å¯ç”¨/ç¦ç”¨

### ğŸ—ï¸ 3. ä»£ç ç»“æ„

#### é…ç½®ç±»
- `BlockchainConfig` - åŒºå—é“¾é…ç½®å±æ€§ç±»
- `FiscoBcosSdkConfig` - FISCO BCOS SDKåˆå§‹åŒ–é…ç½®

#### æœåŠ¡å±‚
- `BlockchainService` - åŒºå—é“¾åŸºç¡€æœåŠ¡(è¿æ¥ã€çŠ¶æ€æ£€æŸ¥)
- `DefectTraceService` - ç¼ºé™·æº¯æºæœåŠ¡(ä¸Šé“¾ã€æŸ¥è¯¢ã€éªŒè¯)

#### æ§åˆ¶å±‚
- `BlockchainController` - æä¾›REST APIæ¥å£

#### æ™ºèƒ½åˆçº¦
- `DefectTrace.sol` - ç¼ºé™·æ£€æµ‹æº¯æºæ™ºèƒ½åˆçº¦

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€: ä»…ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“(ä¸å¯ç”¨åŒºå—é“¾)

**å½“å‰é…ç½®å·²ç»æ˜¯è¿™ç§æ¨¡å¼**,æ— éœ€ä»»ä½•æ“ä½œ,é¡¹ç›®å¯ä»¥æ­£å¸¸è¿è¡Œã€‚

```yaml
# application.yaml
blockchain:
  enabled: false  # åŒºå—é“¾åŠŸèƒ½å…³é—­
```

é¡¹ç›®ä¼šè‡ªåŠ¨è·³è¿‡æ‰€æœ‰åŒºå—é“¾ç›¸å…³çš„Beanåˆå§‹åŒ–,ä¸å½±å“ç°æœ‰åŠŸèƒ½ã€‚

---

### æ–¹å¼äºŒ: å¯ç”¨åŒºå—é“¾åŠŸèƒ½(å®Œæ•´æº¯æº)

#### æ­¥éª¤1: éƒ¨ç½²FISCO BCOSèŠ‚ç‚¹

**æœ€ç®€å•çš„æ–¹å¼ - ä½¿ç”¨Docker:**

```bash
# æ‹‰å–é•œåƒ
docker pull fiscoorg/fiscobcos:v3.6.0

# è¿è¡ŒèŠ‚ç‚¹
docker run -d --name fisco-node -p 30300:30300 -p 20200:20200 fiscoorg/fiscobcos:v3.6.0

# éªŒè¯è¿è¡Œ
docker logs fisco-node
```

**æˆ–è€…ä½¿ç”¨å»ºé“¾è„šæœ¬:**

```bash
# ä¸‹è½½è„šæœ¬
curl -#LO https://github.com/FISCO-BCOS/FISCO-BCOS/releases/download/v3.6.0/build_chain.sh
chmod +x build_chain.sh

# æ„å»º4èŠ‚ç‚¹é“¾
bash build_chain.sh -l 127.0.0.1:4 -p 30300,20200

# å¯åŠ¨èŠ‚ç‚¹
bash nodes/127.0.0.1/start_all.sh
```

#### æ­¥éª¤2: éƒ¨ç½²æ™ºèƒ½åˆçº¦

```bash
# 1. ä¸‹è½½æ§åˆ¶å°
cd ~/fisco
curl -#LO https://github.com/FISCO-BCOS/console/releases/download/v3.6.0/download_console.sh
bash download_console.sh

# 2. å¯åŠ¨æ§åˆ¶å°
cd console
bash start.sh

# 3. åœ¨æ§åˆ¶å°ä¸­éƒ¨ç½²åˆçº¦(éœ€è¦å…ˆç¼–è¯‘å¥½DefectTrace.sol)
[group0]: deploy DefectTrace

# 4. è®°å½•åˆçº¦åœ°å€,ä¾‹å¦‚: 0x1234567890abcdef...
```

#### æ­¥éª¤3: å¤åˆ¶è¯ä¹¦åˆ°é¡¹ç›®

```bash
# åˆ›å»ºè¯ä¹¦ç›®å½•
mkdir -p defectDetection/src/main/resources/blockchain/conf

# å¤åˆ¶SDKè¯ä¹¦
cp ~/fisco/nodes/127.0.0.1/sdk/* defectDetection/src/main/resources/blockchain/conf/
```

#### æ­¥éª¤4: ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `defectDetection/src/main/resources/application.yaml`:

```yaml
blockchain:
  enabled: true  # å¯ç”¨åŒºå—é“¾
  peers: 127.0.0.1:20200  # èŠ‚ç‚¹åœ°å€
  group-id: group0
  cert-path: blockchain/conf
  contracts:
    defect-trace: "0xä½ çš„åˆçº¦åœ°å€"  # å¡«å†™æ­¥éª¤2ä¸­çš„åˆçº¦åœ°å€
```

#### æ­¥éª¤5: å¯åŠ¨é¡¹ç›®

```bash
mvn spring-boot:run
```

æŸ¥çœ‹æ—¥å¿—,åº”è¯¥çœ‹åˆ°:
```
âœ… åŒºå—é“¾è¿æ¥æˆåŠŸ! å½“å‰åŒºå—é«˜åº¦: 1
ğŸ” åŠ å¯†å¥—ä»¶å·²é…ç½®, åœ°å€: 0xabcdef...
```

#### æ­¥éª¤6: æµ‹è¯•æ¥å£

è®¿é—® Swagger: http://localhost:8081/swagger-ui/index.html

æµ‹è¯• `blockchain-controller`:
- `GET /blockchain/status` - æŸ¥çœ‹åŒºå—é“¾çŠ¶æ€
- `GET /blockchain/blockNumber` - æŸ¥çœ‹åŒºå—é«˜åº¦

---

## ğŸ“ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: ç¼ºé™·æ£€æµ‹åè‡ªåŠ¨ä¸Šé“¾

```java
@Service
public class DefectDetectionService {
    
    @Autowired
    private DefectionService defectionService;
    
    @Autowired(required = false)  // åŒºå—é“¾ç¦ç”¨æ—¶ä¸æ³¨å…¥
    private DefectTraceService defectTraceService;
    
    public void saveDetectedDefect(Defection defection) {
        // 1. ä¿å­˜åˆ°MySQLæ•°æ®åº“
        defectionService.save(defection);
        
        // 2. å¦‚æœåŒºå—é“¾å·²å¯ç”¨,åŒæ—¶ä¸Šé“¾
        if (defectTraceService != null) {
            String txHash = defectTraceService.saveDefectToChain(defection);
            log.info("ç¼ºé™·è®°å½•å·²ä¸Šé“¾,äº¤æ˜“å“ˆå¸Œ: {}", txHash);
        }
    }
}
```

### åœºæ™¯2: éªŒè¯é“¾ä¸Šæ•°æ®

```java
// éªŒè¯æŸä¸ªç¼ºé™·è®°å½•çš„å®Œæ•´æ€§
boolean isValid = defectTraceService.verifyDefectOnChain(defection, txHash);
if (isValid) {
    log.info("æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡");
}
```

### åœºæ™¯3: æ‰¹é‡ä¸Šé“¾

```java
List<Defection> defections = getDefections();
Map<Integer, String> results = defectTraceService.batchSaveToChain(defections);
log.info("æ‰¹é‡ä¸Šé“¾å®Œæˆ,æˆåŠŸ: {}", results.size());
```

---

## ğŸ¯ APIæ¥å£è¯´æ˜

### è·å–åŒºå—é“¾çŠ¶æ€
```http
GET http://localhost:8081/blockchain/status
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "code": 200,
  "message": "è·å–åŒºå—é“¾çŠ¶æ€æˆåŠŸ",
  "data": {
    "available": true,
    "blockNumber": 100,
    "message": "åŒºå—é“¾æœåŠ¡è¿è¡Œæ­£å¸¸"
  }
}
```

### è·å–åŒºå—é«˜åº¦
```http
GET http://localhost:8081/blockchain/blockNumber
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### å®Œæ•´é…ç½®é¡¹

```yaml
blockchain:
  # æ˜¯å¦å¯ç”¨åŒºå—é“¾åŠŸèƒ½
  enabled: false
  
  # FISCO BCOSèŠ‚ç‚¹åœ°å€(å¯é…ç½®å¤šä¸ª,é€—å·åˆ†éš”)
  peers: 127.0.0.1:20200,127.0.0.1:20201
  
  # ç¾¤ç»„ID
  group-id: group0
  
  # è¯ä¹¦è·¯å¾„(æ”¯æŒå¤šä¸ªè·¯å¾„,è‡ªåŠ¨å°è¯•)
  cert-path: conf,config,blockchain/conf
  
  # ç§é’¥(å¯é€‰,ä¸å¡«å†™å°†è‡ªåŠ¨ç”Ÿæˆ)
  hex-private-key: ""
  
  # æ™ºèƒ½åˆçº¦åœ°å€
  contracts:
    defect-trace: ""  # ç¼ºé™·æº¯æºåˆçº¦
    raw-material: ""  # åŸææ–™åˆçº¦(é¢„ç•™)
    data-center: ""   # æ•°æ®ä¸­å¿ƒåˆçº¦(é¢„ç•™)
```

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- ğŸ“– [å®Œæ•´éƒ¨ç½²æŒ‡å—](./åŒºå—é“¾éƒ¨ç½²æŒ‡å—.md) - è¯¦ç»†çš„éƒ¨ç½²æ­¥éª¤å’Œtroubleshooting
- ğŸ” æŸ¥çœ‹æ™ºèƒ½åˆçº¦æºç : `defectDetection/src/main/resources/contracts/DefectTrace.sol`
- ğŸ—ï¸ æŸ¥çœ‹Javaä»£ç : `defectDetection/src/main/java/com/ggbond/defectdetection/service/blockchain/`

---

## â“ å¸¸è§é—®é¢˜

### Q: ä¸å¯ç”¨åŒºå—é“¾ä¼šå½±å“é¡¹ç›®è¿è¡Œå—?
**A:** ä¸ä¼š!æ‰€æœ‰åŒºå—é“¾ç›¸å…³çš„ç±»éƒ½ä½¿ç”¨äº† `@ConditionalOnProperty`,åªæœ‰å½“ `blockchain.enabled=true` æ—¶æ‰ä¼šåŠ è½½ã€‚

### Q: å¦‚ä½•ä¸´æ—¶ç¦ç”¨åŒºå—é“¾?
**A:** ä¿®æ”¹ `application.yaml` ä¸­çš„ `blockchain.enabled: false` å³å¯ã€‚

### Q: éƒ¨ç½²åŒºå—é“¾èŠ‚ç‚¹å¾ˆå¤æ‚å—?
**A:** ä½¿ç”¨Dockeræ–¹å¼åªéœ€è¦ä¸€æ¡å‘½ä»¤!æˆ–è€…æŸ¥çœ‹[è¯¦ç»†éƒ¨ç½²æŒ‡å—](./åŒºå—é“¾éƒ¨ç½²æŒ‡å—.md)ã€‚

### Q: æ™ºèƒ½åˆçº¦å¯ä»¥ä¿®æ”¹å—?
**A:** å¯ä»¥!ä¿®æ”¹ `DefectTrace.sol` åé‡æ–°ç¼–è¯‘éƒ¨ç½²å³å¯ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹é“¾ä¸Šæ•°æ®?
**A:** ä½¿ç”¨FISCO BCOSæ§åˆ¶å°,æˆ–è€…é€šè¿‡ `DefectTraceService.getDefectFromChain()` æ–¹æ³•ã€‚

---

## ğŸ‰ æ€»ç»“

âœ… åŒºå—é“¾åŠŸèƒ½**å·²é›†æˆ**åˆ°é¡¹ç›®ä¸­  
âœ… é»˜è®¤**ç¦ç”¨**çŠ¶æ€,ä¸å½±å“ç°æœ‰åŠŸèƒ½  
âœ… éœ€è¦æ—¶å¯ä»¥éšæ—¶**å¯ç”¨**  
âœ… æä¾›å®Œæ•´çš„**APIæ¥å£**  
âœ… ä»£ç å·²**ä¼˜åŒ–**,æ”¯æŒå¯é€‰æ³¨å…¥  
âœ… åŒ…å«**è¯¦ç»†æ–‡æ¡£**å’Œä½¿ç”¨ç¤ºä¾‹  

**ä¸‹ä¸€æ­¥:**
1. å¦‚æœæš‚æ—¶ä¸éœ€è¦åŒºå—é“¾,ä»€ä¹ˆéƒ½ä¸ç”¨åš,é¡¹ç›®æ­£å¸¸è¿è¡Œ
2. å¦‚æœéœ€è¦å¯ç”¨,æŒ‰ç…§ä¸Šé¢çš„"å¿«é€Ÿå¼€å§‹-æ–¹å¼äºŒ"æ“ä½œå³å¯

---

**éœ€è¦å¸®åŠ©?** æŸ¥çœ‹ [åŒºå—é“¾éƒ¨ç½²æŒ‡å—.md](./åŒºå—é“¾éƒ¨ç½²æŒ‡å—.md) è·å–æ›´å¤šä¿¡æ¯!
